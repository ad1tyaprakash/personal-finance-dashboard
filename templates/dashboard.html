{% extends "layout.html" %}

{% block content %}
<div class="container mt-4">
  <h2>Dashboard</h2>
  <div class="row">
    <div class="card">
      <h3>Net worth</h3>
      <p>Stocks: ${{ net_worth }}<br>Savings: ${{ total_savings }}<br><strong>Total: ${{ total_net_worth }}</strong></p>
    </div>
    <div class="card">
      <h3>Deficit / Surplus</h3>
      <p>${{ deficit }}</p>
    </div>
  </div>

  <section>
    <h3>Expense Breakdown</h3>
    <div class="chart-container">
      <canvas id="expenseChart" width="400" height="200"></canvas>
      <p id="no-expense-msg" style="display:none;">No expense data to show.</p>
    </div>
  </section>

  <section>
    <h3>Your Stocks</h3>
    <table>
      <thead><tr><th>Ticker</th><th>Qty</th><th>Buy</th><th>Current</th><th>Value</th><th>Profit</th></tr></thead>
      <tbody>
      {% for s in stock_data %}
        <tr>
          <td>{{ s.ticker }}</td>
          <td>{{ s.quantity }}</td>
          <td>{{ s.purchase_price }}</td>
          <td>{{ s.current_price }}</td>
          <td>{{ s.current_value }}</td>
          <td>{{ s.profit }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>

    <h4>Add stock</h4>
    <form action="/add_stock" method="post">
      <select name="ticker">
        {% for sym, name in available_stocks %}
          <option value="{{ sym }}">{{ sym }} â€” {{ name }}</option>
        {% endfor %}
      </select>
      <input name="quantity" type="number" step="any" placeholder="Quantity" required>
      <input name="purchase_price" type="number" step="any" placeholder="Purchase price" required>
      <button type="submit">Add</button>
    </form>
  </section>

  <!-- Load Chart.js from CDN to ensure compatibility -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // labels/data are already converted to native types in app.py
      const labels = {{ labels|tojson }};
      const data = {{ data|tojson }};

      const noMsg = document.getElementById('no-expense-msg');
      const canvas = document.getElementById('expenseChart');

      if (!Array.isArray(labels) || !Array.isArray(data) || data.length === 0) {
        // show friendly message if no data
        if (canvas) canvas.style.display = 'none';
        if (noMsg) noMsg.style.display = 'block';
        return;
      }

      // ensure all data are numbers
      const numeric = data.map(d => Number(d) || 0);

      const ctx = canvas.getContext('2d');
      // destroy existing chart instance if any (avoid double-render on HMR)
      if (window.expenseChartInstance) {
        window.expenseChartInstance.destroy();
      }

      const colors = [
        '#4e79a7','#f28e2b','#e15759','#76b7b2','#59a14f',
        '#edc949','#af7aa1','#ff9da7','#9c755f','#bab0ac'
      ];

      window.expenseChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: numeric,
            backgroundColor: colors.slice(0, labels.length),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'right' }
          }
        }
      });
    });
  </script>
</div>
{% endblock %}
