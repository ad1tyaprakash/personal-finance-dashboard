{% extends "layout.html" %}

{% block content %}
<div class="container mt-4">
  <h2>Dashboard</h2>
  <div class="row">
    <div class="card">
      <h3>Net worth</h3>
      <p>Stocks: ${{ net_worth }}<br>Savings: ${{ total_savings }}<br><strong>Total: ${{ total_net_worth }}</strong></p>

      <h4>Add Income</h4>
      <form action="/add_income" method="post" style="display:flex;flex-direction:column;gap:.3rem;">
        <input name="source" placeholder="Source (e.g., Salary)" required>
        <input name="amount" type="number" step="0.01" placeholder="Amount" required>
        <input name="date" type="date" placeholder="Date">
        <button class="btn-success" type="submit">Add Income</button>
      </form>
    </div>

    <div class="card">
      <h3>Deficit / Surplus</h3>
      <p>${{ deficit }}</p>

      <h4>Add Expense</h4>
      <form action="/add_expense" method="post" style="display:flex;flex-direction:column;gap:.3rem;">
        <input name="category" placeholder="Category (e.g., Food)" required>
        <input name="amount" type="number" step="0.01" placeholder="Amount" required>
        <input name="date" type="date" placeholder="Date">
        <button class="btn-danger" type="submit">Add Expense</button>
      </form>
    </div>
  </div>

  <section style="margin-top:1rem;">
    <h3>Expense Breakdown</h3>
    <div class="chart-container" style="height:260px;">
      <canvas id="expenseChart"></canvas>
      <p id="no-expense-msg" style="display:none;">No expense data to show.</p>
    </div>
  </section>

  <section style="margin-top:1rem;">
    <h3>Net worth (Assets vs Liabilities)</h3>
    <div class="chart-container" style="height:260px;">
      <canvas id="netWorthChart"></canvas>
      <p id="no-networth-msg" style="display:none;">No net worth data to show.</p>
    </div>
  </section>

  <section style="margin-top:1rem;">
    <h3>Your Stocks</h3>
    <table>
      <thead><tr><th>Ticker</th><th>Qty</th><th>Buy</th><th>Current</th><th>Value</th><th>Profit</th></tr></thead>
      <tbody>
      {% for s in stock_data %}
        <tr>
          <td>{{ s.ticker }}</td>
          <td>{{ s.quantity }}</td>
          <td>{{ s.purchase_price }}</td>
          <td>{{ s.current_price }}</td>
          <td>{{ s.current_value }}</td>
          <td>{{ s.profit }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>

    <h4>Add stock</h4>
    <form action="/add_stock" method="post">
      <select name="ticker">
        {% for sym, name in available_stocks %}
          <option value="{{ sym }}">{{ sym }} â€” {{ name }}</option>
        {% endfor %}
      </select>
      <input name="quantity" type="number" step="any" placeholder="Quantity" required>
      <input name="purchase_price" type="number" step="any" placeholder="Purchase price" required>
      <button type="submit">Add</button>
    </form>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const labels = {{ labels|tojson }};
      const data = {{ data|tojson }};

      const noMsg = document.getElementById('no-expense-msg');
      const canvas = document.getElementById('expenseChart');

      if (!Array.isArray(labels) || !Array.isArray(data) || data.length === 0) {
        if (canvas) canvas.style.display = 'none';
        if (noMsg) noMsg.style.display = 'block';
      } else {
        const numeric = data.map(d => Number(d) || 0);
        const ctx = canvas.getContext('2d');
        if (window.expenseChartInstance) window.expenseChartInstance.destroy();
        window.expenseChartInstance = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: labels,
            datasets: [{ data: numeric, backgroundColor: ['#4e79a7','#f28e2b','#e15759','#76b7b2','#59a14f'] }]
          },
          options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'right'}} }
        });
      }

      const labelsNet = {{ labels_net|tojson }};
      const dataNet = {{ data_net|tojson }};

      const noNetMsg = document.getElementById('no-networth-msg');
      const netCanvas = document.getElementById('netWorthChart');

      // explicit distinct colors for Assets vs Liabilities
      const netBackground = ['#2ca02c', '#d62728'];    // green, red
      const netBorder = ['#1f7a1f', '#a11b1b'];

      if (!Array.isArray(labelsNet) || !Array.isArray(dataNet) || (dataNet.reduce((a,b)=>a+b,0) === 0)) {
        if (netCanvas) netCanvas.style.display = 'none';
        if (noNetMsg) noNetMsg.style.display = 'block';
      } else {
        const numericNet = dataNet.map(d => Number(d) || 0);
        const ctx2 = netCanvas.getContext('2d');
        if (window.netWorthChartInstance) window.netWorthChartInstance.destroy();
        window.netWorthChartInstance = new Chart(ctx2, {
          type: 'doughnut',
          data: {
            labels: labelsNet,
            datasets: [{
              data: numericNet,
              backgroundColor: netBackground,
              borderColor: netBorder,
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'right' },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const val = Number(context.raw || 0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
                    return `${context.label}: $${val}`;
                  }
                }
              }
            }
          }
        });
      }
    });
  </script>
</div>
{% endblock %}
